<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cha√Ænage Pro ‚Äî Pharmacies Maroc</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ============================================================
   THEME SYSTEM ‚Äî CSS Variables for Dark & Light
   ============================================================ */
:root {
  --font-body: 'DM Sans', sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
  --green: #10b981;
  --green-dim: rgba(16,185,129,0.12);
  --green-glow: rgba(16,185,129,0.35);
  --red: #ef4444;
  --red-dim: rgba(239,68,68,0.12);
  --amber: #f59e0b;
  --amber-dim: rgba(245,158,11,0.12);
  --blue: #3b82f6;
  --blue-dim: rgba(59,130,246,0.12);
  --radius: 14px;
  --radius-sm: 10px;
  --radius-xs: 7px;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.18);
  --transition: 0.25s cubic-bezier(0.4,0,0.2,1);
}

/* DARK THEME */
[data-theme="dark"] {
  --bg-base: #06090f;
  --bg-primary: #0a0f1a;
  --bg-secondary: #111827;
  --bg-card: #1a2236;
  --bg-elevated: #1f2b3f;
  --bg-input: #151d2e;
  --bg-overlay: rgba(6,9,15,0.88);
  --text-primary: #f1f5f9;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --text-inverse: #0a0f1a;
  --border: rgba(255,255,255,0.06);
  --border-hover: rgba(255,255,255,0.12);
  --border-focus: var(--green);
  --scrollbar-thumb: #334155;
  --map-bg: #0f172a;
  --infowindow-bg: #1a2236;
  --infowindow-text: #f1f5f9;
  --infowindow-muted: #94a3b8;
}

/* LIGHT THEME */
[data-theme="light"] {
  --bg-base: #f0f2f5;
  --bg-primary: #ffffff;
  --bg-secondary: #f8f9fb;
  --bg-card: #ffffff;
  --bg-elevated: #ffffff;
  --bg-input: #f0f2f5;
  --bg-overlay: rgba(255,255,255,0.92);
  --text-primary: #111827;
  --text-secondary: #4b5563;
  --text-muted: #9ca3af;
  --text-inverse: #ffffff;
  --border: rgba(0,0,0,0.08);
  --border-hover: rgba(0,0,0,0.15);
  --border-focus: var(--green);
  --scrollbar-thumb: #cbd5e1;
  --map-bg: #e8edf3;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.1);
  --infowindow-bg: #ffffff;
  --infowindow-text: #111827;
  --infowindow-muted: #6b7280;
}

/* ============================================================
   RESET & BASE
   ============================================================ */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: var(--font-body);
  background: var(--bg-base);
  color: var(--text-primary);
  height: 100vh;
  overflow: hidden;
  transition: background var(--transition), color var(--transition);
}

input, button, select, textarea { font-family: inherit; }

::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }

/* ============================================================
   PAGE / VIEW SYSTEM
   ============================================================ */
.page {
  position: fixed;
  inset: 0;
  display: none;
  z-index: 1;
}
.page.active {
  display: flex;
}

/* ============================================================
   AUTH PAGES (Login / Register)
   ============================================================ */
.auth-page {
  align-items: center;
  justify-content: center;
  background: var(--bg-base);
  overflow: auto;
}

.auth-backdrop {
  position: absolute;
  inset: 0;
  overflow: hidden;
  pointer-events: none;
}

.auth-backdrop .orb {
  position: absolute;
  border-radius: 50%;
  filter: blur(80px);
  opacity: 0.15;
  animation: orb-float 20s ease-in-out infinite alternate;
}

[data-theme="light"] .auth-backdrop .orb { opacity: 0.08; }

.auth-backdrop .orb:nth-child(1) {
  width: 500px; height: 500px;
  background: var(--green);
  top: -10%; left: -5%;
}
.auth-backdrop .orb:nth-child(2) {
  width: 400px; height: 400px;
  background: var(--blue);
  bottom: -10%; right: -5%;
  animation-delay: -7s;
}
.auth-backdrop .orb:nth-child(3) {
  width: 300px; height: 300px;
  background: var(--amber);
  top: 50%; left: 50%;
  transform: translate(-50%,-50%);
  animation-delay: -14s;
}

@keyframes orb-float {
  0% { transform: translate(0,0) scale(1); }
  33% { transform: translate(30px,-40px) scale(1.1); }
  66% { transform: translate(-20px,30px) scale(0.95); }
  100% { transform: translate(10px,-10px) scale(1.05); }
}

.auth-card {
  position: relative;
  z-index: 2;
  width: 100%;
  max-width: 440px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 44px 40px;
  box-shadow: var(--shadow-lg);
  animation: auth-enter 0.5s ease-out;
}

@keyframes auth-enter {
  from { opacity:0; transform: translateY(20px) scale(0.97); }
  to { opacity:1; transform: translateY(0) scale(1); }
}

.auth-logo {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 32px;
}

.auth-logo-icon {
  width: 44px; height: 44px;
  background: linear-gradient(135deg, var(--green), #059669);
  border-radius: 13px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  box-shadow: 0 4px 20px var(--green-glow);
}

.auth-logo h2 {
  font-size: 22px;
  font-weight: 800;
  letter-spacing: -0.5px;
}

.auth-logo h2 em {
  font-style: normal;
  background: linear-gradient(135deg, var(--green), #34d399);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.auth-title {
  font-size: 26px;
  font-weight: 700;
  margin-bottom: 6px;
  letter-spacing: -0.5px;
}

.auth-subtitle {
  font-size: 14px;
  color: var(--text-muted);
  margin-bottom: 28px;
}

.form-group {
  margin-bottom: 18px;
}

.form-group label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 7px;
}

.form-input {
  width: 100%;
  padding: 13px 16px;
  background: var(--bg-input);
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: 14px;
  outline: none;
  transition: all var(--transition);
}

.form-input:focus {
  border-color: var(--green);
  box-shadow: 0 0 0 3px var(--green-dim);
}

.form-input::placeholder { color: var(--text-muted); }

.form-error {
  font-size: 12px;
  color: var(--red);
  margin-top: 6px;
  display: none;
}

.form-error.visible { display: block; }

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 13px 24px;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition);
  text-decoration: none;
}

.btn-block { width: 100%; }

.btn-green {
  background: linear-gradient(135deg, var(--green), #059669);
  color: white;
  box-shadow: 0 4px 16px var(--green-glow);
}
.btn-green:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 24px var(--green-glow);
}

.btn-outline {
  background: transparent;
  color: var(--text-secondary);
  border: 1.5px solid var(--border);
}
.btn-outline:hover {
  border-color: var(--border-hover);
  color: var(--text-primary);
}

.btn-ghost {
  background: transparent;
  color: var(--text-muted);
  padding: 8px 12px;
  font-size: 13px;
}
.btn-ghost:hover { color: var(--text-primary); }

.auth-footer {
  text-align: center;
  margin-top: 24px;
  font-size: 13px;
  color: var(--text-muted);
}

.auth-footer a {
  color: var(--green);
  text-decoration: none;
  font-weight: 600;
  cursor: pointer;
}

.auth-footer a:hover { text-decoration: underline; }

.auth-divider {
  display: flex;
  align-items: center;
  gap: 12px;
  margin: 22px 0;
  color: var(--text-muted);
  font-size: 12px;
}

.auth-divider::before,
.auth-divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

/* Theme toggle (floating) */
.theme-toggle-float {
  position: absolute;
  top: 24px;
  right: 24px;
  z-index: 50;
  width: 42px; height: 42px;
  border-radius: 50%;
  background: var(--bg-card);
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 18px;
  transition: all var(--transition);
  box-shadow: var(--shadow-sm);
}
.theme-toggle-float:hover {
  border-color: var(--border-hover);
  transform: scale(1.08);
}

/* ============================================================
   PRICING PAGE
   ============================================================ */
.pricing-page {
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: var(--bg-base);
  overflow: auto;
  padding: 40px 20px;
}

.pricing-header {
  text-align: center;
  margin-bottom: 48px;
  max-width: 600px;
  animation: auth-enter 0.5s ease-out;
}

.pricing-header h1 {
  font-size: 36px;
  font-weight: 800;
  letter-spacing: -1px;
  margin-bottom: 12px;
}

.pricing-header h1 em {
  font-style: normal;
  background: linear-gradient(135deg, var(--green), #34d399);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.pricing-header p {
  font-size: 16px;
  color: var(--text-secondary);
  line-height: 1.6;
}

.pricing-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
  max-width: 960px;
  width: 100%;
  animation: auth-enter 0.6s ease-out 0.1s both;
}

@media (max-width: 800px) {
  .pricing-grid { grid-template-columns: 1fr; max-width: 400px; }
}

.price-card {
  background: var(--bg-card);
  border: 1.5px solid var(--border);
  border-radius: 18px;
  padding: 32px 28px;
  text-align: center;
  position: relative;
  transition: all var(--transition);
}

.price-card:hover {
  border-color: var(--border-hover);
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
}

.price-card.featured {
  border-color: var(--green);
  box-shadow: 0 0 0 1px var(--green), 0 8px 32px var(--green-glow);
}

.price-card.featured::before {
  content: 'POPULAIRE';
  position: absolute;
  top: -12px; left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, var(--green), #059669);
  color: white;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 1.5px;
  padding: 4px 16px;
  border-radius: 20px;
}

.price-card .plan-name {
  font-size: 13px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-muted);
  margin-bottom: 12px;
}

.price-card .plan-price {
  font-size: 48px;
  font-weight: 800;
  font-family: var(--font-mono);
  letter-spacing: -2px;
  margin-bottom: 4px;
}

.price-card .plan-price sup {
  font-size: 20px;
  vertical-align: super;
  color: var(--text-muted);
}

.price-card .plan-period {
  font-size: 13px;
  color: var(--text-muted);
  margin-bottom: 24px;
}

.price-card .plan-features {
  list-style: none;
  text-align: left;
  margin-bottom: 28px;
}

.price-card .plan-features li {
  font-size: 13px;
  color: var(--text-secondary);
  padding: 7px 0;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 8px;
}

.price-card .plan-features li:last-child { border: none; }

.price-card .plan-features .check {
  color: var(--green);
  font-weight: 700;
}

.price-card .plan-features .x {
  color: var(--text-muted);
}

.pricing-back {
  margin-top: 32px;
  animation: auth-enter 0.6s ease-out 0.2s both;
}

/* ============================================================
   PAYMENT SUCCESS
   ============================================================ */
.success-card {
  text-align: center;
  max-width: 440px;
  animation: auth-enter 0.5s ease-out;
}

.success-icon {
  width: 80px; height: 80px;
  background: var(--green-dim);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  margin: 0 auto 20px;
  animation: success-pop 0.4s ease-out 0.2s both;
}

@keyframes success-pop {
  0% { transform: scale(0); }
  60% { transform: scale(1.15); }
  100% { transform: scale(1); }
}

/* ============================================================
   MAIN APP (Map + Sidebar)
   ============================================================ */
.app-page {
  background: var(--bg-base);
}

/* Sidebar */
.sidebar {
  width: 400px;
  min-width: 400px;
  height: 100vh;
  background: var(--bg-secondary);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  z-index: 10;
  overflow: hidden;
  transition: background var(--transition), border-color var(--transition);
}

.sidebar-header {
  padding: 18px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  transition: border-color var(--transition);
}

.sidebar-header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.s-logo {
  width: 36px; height: 36px;
  background: linear-gradient(135deg, var(--green), #059669);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 17px;
  box-shadow: 0 3px 12px var(--green-glow);
}

.s-logo-text h1 {
  font-size: 17px;
  font-weight: 800;
  letter-spacing: -0.5px;
  background: linear-gradient(135deg, var(--green), #34d399);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.s-logo-text span {
  font-family: var(--font-mono);
  font-size: 9px;
  color: var(--text-muted);
  letter-spacing: 1.5px;
  text-transform: uppercase;
}

.header-actions {
  display: flex;
  gap: 6px;
}

.header-btn {
  width: 34px; height: 34px;
  border-radius: 9px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 15px;
  transition: all var(--transition);
  color: var(--text-muted);
}
.header-btn:hover {
  border-color: var(--border-hover);
  color: var(--text-primary);
}

/* User pill */
.user-pill {
  padding: 10px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
  transition: border-color var(--transition);
}

.user-avatar {
  width: 30px; height: 30px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--green-dim), var(--blue-dim));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  font-weight: 700;
  color: var(--green);
  flex-shrink: 0;
}

.user-info { flex: 1; min-width: 0; }
.user-name { font-weight: 600; font-size: 13px; }
.user-plan {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--green);
  background: var(--green-dim);
  padding: 1px 7px;
  border-radius: 4px;
  display: inline-block;
  margin-top: 1px;
}

.user-logout {
  font-size: 12px;
  color: var(--text-muted);
  cursor: pointer;
  background: none;
  border: none;
  font-family: inherit;
  transition: color var(--transition);
}
.user-logout:hover { color: var(--red); }

/* Scan indicator */
.scan-indicator {
  padding: 10px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
  color: var(--text-secondary);
  background: var(--green-dim);
  background-size: 200%;
  transition: all 0.3s;
}

.scan-indicator.scanning {
  color: var(--green);
}

.scan-dot {
  width: 9px; height: 9px;
  border-radius: 50%;
  background: var(--green);
  flex-shrink: 0;
  position: relative;
}

.scan-dot::after {
  content: '';
  position: absolute;
  inset: -3px;
  border-radius: 50%;
  border: 2px solid var(--green);
  opacity: 0;
}

.scanning .scan-dot::after {
  animation: pulse-ring 1.2s ease-out infinite;
}

@keyframes pulse-ring {
  0% { transform:scale(0.8); opacity:0.6; }
  100% { transform:scale(2); opacity:0; }
}

.scan-text { flex: 1; }

.scan-count {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--green);
  background: var(--bg-card);
  padding: 2px 9px;
  border-radius: 6px;
  border: 1px solid var(--border);
}

/* Auto scan row */
.auto-scan-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 9px 20px;
  border-bottom: 1px solid var(--border);
  font-size: 12px;
  color: var(--text-secondary);
}

.toggle-switch {
  position: relative;
  width: 38px; height: 20px;
  cursor: pointer;
  flex-shrink: 0;
}

.toggle-switch input { display: none; }

.toggle-track {
  position: absolute; inset: 0;
  background: var(--bg-input);
  border-radius: 10px;
  transition: 0.3s;
  border: 1px solid var(--border);
}

.toggle-switch input:checked + .toggle-track {
  background: rgba(16,185,129,0.25);
  border-color: var(--green);
}

.toggle-thumb {
  position: absolute;
  left: 2px; top: 2px;
  width: 16px; height: 16px;
  background: var(--text-muted);
  border-radius: 50%;
  transition: 0.3s;
  pointer-events: none;
}

.toggle-switch input:checked ~ .toggle-thumb {
  transform: translateX(18px);
  background: var(--green);
}

.btn-scan-sm {
  margin-left: auto;
  background: var(--green-dim);
  color: var(--green);
  border: 1px solid rgba(16,185,129,0.2);
  border-radius: 7px;
  padding: 4px 10px;
  font-family: var(--font-body);
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-scan-sm:hover { background: rgba(16,185,129,0.2); }

/* Stats */
.stats-bar {
  display: flex;
  gap: 6px;
  padding: 12px 20px;
  border-bottom: 1px solid var(--border);
}

.stat-chip {
  flex: 1;
  padding: 9px 8px;
  background: var(--bg-card);
  border-radius: 9px;
  text-align: center;
  border: 1px solid var(--border);
  transition: background var(--transition), border-color var(--transition);
}

.stat-value {
  font-size: 20px;
  font-weight: 700;
  font-family: var(--font-mono);
  line-height: 1.2;
}

.stat-label {
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  margin-top: 1px;
}

.stat-chip.green .stat-value { color: var(--green); }
.stat-chip.red .stat-value { color: var(--red); }
.stat-chip.amber .stat-value { color: var(--amber); }

/* List header */
.list-header {
  padding: 12px 20px 6px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.list-header h3 {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-muted);
}

.filter-pills { display: flex; gap: 4px; }

.filter-pill {
  font-family: var(--font-mono);
  font-size: 9px;
  padding: 3px 7px;
  border-radius: 5px;
  cursor: pointer;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-muted);
  transition: all 0.2s;
}

.filter-pill.active {
  border-color: var(--green);
  color: var(--green);
  background: var(--green-dim);
}

/* Pharmacy list */
.pharmacy-list {
  flex: 1;
  overflow-y: auto;
  padding: 0 20px 20px;
}

.pharmacy-card {
  padding: 11px 12px;
  background: var(--bg-card);
  border-radius: 9px;
  margin-bottom: 5px;
  border: 1px solid var(--border);
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}

.pharmacy-card::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 3px;
  border-radius: 0 3px 3px 0;
}

.pharmacy-card.valid::before { background: var(--green); }
.pharmacy-card.conflict::before { background: var(--red); }

.pharmacy-card:hover {
  border-color: var(--border-hover);
  transform: translateX(2px);
}

.card-top {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 3px;
}

.p-name {
  font-size: 13px;
  font-weight: 600;
  padding-left: 9px;
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.p-badge {
  font-family: var(--font-mono);
  font-size: 9px;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 4px;
  text-transform: uppercase;
  flex-shrink: 0;
}

.p-badge.valid { background: var(--green-dim); color: var(--green); }
.p-badge.conflict { background: var(--red-dim); color: var(--red); }

.p-address {
  font-size: 11px;
  color: var(--text-muted);
  padding-left: 9px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.p-meta {
  display: flex;
  gap: 10px;
  padding-left: 9px;
  margin-top: 3px;
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-secondary);
}

.p-meta span { color: var(--text-muted); }

/* Config panel */
.config-panel {
  padding: 12px 20px;
  border-top: 1px solid var(--border);
  background: var(--bg-primary);
  transition: background var(--transition);
}

.config-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 7px;
}

.config-row:last-child { margin-bottom: 0; }
.config-row label { font-size: 12px; color: var(--text-secondary); }
.config-row input[type="range"] { width: 120px; accent-color: var(--green); }

.range-val {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--green);
  min-width: 44px;
  text-align: right;
}

/* Map */
.map-container { flex: 1; position: relative; }
#map { width: 100%; height: 100%; }

.map-overlay {
  position: absolute;
  top: 14px; right: 14px;
  background: var(--bg-overlay);
  backdrop-filter: blur(16px);
  border: 1px solid var(--border);
  border-radius: 11px;
  padding: 12px 16px;
  z-index: 5;
  min-width: 190px;
  transition: background var(--transition), border-color var(--transition);
}

.map-overlay h4 {
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-muted);
  margin-bottom: 8px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 9px;
  margin-bottom: 5px;
  font-size: 11px;
  color: var(--text-secondary);
}

.legend-item:last-child { margin-bottom: 0; }

.legend-dot {
  width: 11px; height: 11px;
  border-radius: 50%;
  border: 2px solid;
  flex-shrink: 0;
}

.legend-dot.green { background: var(--green-dim); border-color: var(--green); }
.legend-dot.red { background: var(--red-dim); border-color: var(--red); }
.legend-dot.amber { background: var(--amber-dim); border-color: var(--amber); }

.map-scan-bar {
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  z-index: 6;
  overflow: hidden;
}

.map-scan-bar.active::after {
  content: '';
  position: absolute;
  top: 0; left: -40%;
  width: 40%; height: 100%;
  background: linear-gradient(90deg, transparent, var(--green), transparent);
  animation: scan-slide 1.2s ease-in-out infinite;
}

@keyframes scan-slide {
  0% { left: -40%; }
  100% { left: 100%; }
}

.move-hint {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-overlay);
  backdrop-filter: blur(16px);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 9px 18px;
  z-index: 5;
  font-size: 12px;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 8px;
  transition: opacity 0.5s;
  white-space: nowrap;
}

.move-hint .hi { animation: bob 2s ease-in-out infinite; }
@keyframes bob { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-3px)} }

/* Responsive */
@media (max-width: 900px) {
  .app-page { flex-direction: column; }
  .sidebar { width: 100%; min-width: unset; height: 45vh; }
  .map-container { height: 55vh; }
  .pricing-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<!-- ==================== THEME TOGGLE (global) ==================== -->
<button class="theme-toggle-float" id="themeToggle" onclick="toggleTheme()" title="Changer le th√®me">üåô</button>

<!-- ==================== PAGE: LOGIN ==================== -->
<div class="page auth-page active" id="pageLogin">
  <div class="auth-backdrop">
    <div class="orb"></div>
    <div class="orb"></div>
    <div class="orb"></div>
  </div>
  <div class="auth-card">
    <div class="auth-logo">
      <div class="auth-logo-icon">‚öïÔ∏è</div>
      <h2>Cha√Ænage <em>Pro</em></h2>
    </div>
    <div class="auth-title">Connexion</div>
    <div class="auth-subtitle">Acc√©dez √† votre tableau de bord de cha√Ænage</div>

    <div class="form-group">
      <label>Email</label>
      <input class="form-input" type="email" id="loginEmail" placeholder="votre@email.com" />
    </div>
    <div class="form-group">
      <label>Mot de passe</label>
      <input class="form-input" type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
    </div>
    <div class="form-error" id="loginError">Email ou mot de passe incorrect</div>

    <button class="btn btn-green btn-block" onclick="handleLogin()">Se connecter</button>

    <div class="auth-divider">ou</div>

    <button class="btn btn-outline btn-block" onclick="handleDemoLogin()">
      üöÄ Acc√®s d√©monstration
    </button>

    <div class="auth-footer">
      Pas encore de compte ? <a onclick="showPage('pageRegister')">Cr√©er un compte</a>
    </div>
  </div>
</div>

<!-- ==================== PAGE: REGISTER ==================== -->
<div class="page auth-page" id="pageRegister">
  <div class="auth-backdrop">
    <div class="orb"></div>
    <div class="orb"></div>
    <div class="orb"></div>
  </div>
  <div class="auth-card">
    <div class="auth-logo">
      <div class="auth-logo-icon">‚öïÔ∏è</div>
      <h2>Cha√Ænage <em>Pro</em></h2>
    </div>
    <div class="auth-title">Cr√©er un compte</div>
    <div class="auth-subtitle">Commencez votre essai gratuit de 14 jours</div>

    <div class="form-group">
      <label>Nom complet</label>
      <input class="form-input" type="text" id="regName" placeholder="Mohammed Alami" />
    </div>
    <div class="form-group">
      <label>Email</label>
      <input class="form-input" type="email" id="regEmail" placeholder="votre@email.com" />
    </div>
    <div class="form-group">
      <label>Mot de passe</label>
      <input class="form-input" type="password" id="regPassword" placeholder="Minimum 8 caract√®res" />
    </div>
    <div class="form-group">
      <label>Ville</label>
      <input class="form-input" type="text" id="regCity" placeholder="Casablanca" />
    </div>
    <div class="form-error" id="regError"></div>

    <button class="btn btn-green btn-block" onclick="handleRegister()">Cr√©er mon compte</button>

    <div class="auth-footer">
      D√©j√† inscrit ? <a onclick="showPage('pageLogin')">Se connecter</a>
    </div>
  </div>
</div>

<!-- ==================== PAGE: PRICING ==================== -->
<div class="page pricing-page" id="pagePricing">
  <div class="pricing-header">
    <h1>Choisissez votre <em>plan</em></h1>
    <p>Analysez le cha√Ænage r√©glementaire des pharmacies au Maroc avec des donn√©es Google Maps en temps r√©el.</p>
  </div>

  <div class="pricing-grid">
    <!-- FREE -->
    <div class="price-card">
      <div class="plan-name">Gratuit</div>
      <div class="plan-price">0<sup>MAD</sup></div>
      <div class="plan-period">pour toujours</div>
      <ul class="plan-features">
        <li><span class="check">‚úì</span> 5 scans / jour</li>
        <li><span class="check">‚úì</span> Vue carte basique</li>
        <li><span class="check">‚úì</span> Analyse de cha√Ænage</li>
        <li><span class="x">‚úó</span> Export PDF</li>
        <li><span class="x">‚úó</span> Historique</li>
      </ul>
      <button class="btn btn-outline btn-block" onclick="selectPlan('free')">Plan actuel</button>
    </div>

    <!-- PRO -->
    <div class="price-card featured">
      <div class="plan-name">Pro</div>
      <div class="plan-price">199<sup>MAD</sup></div>
      <div class="plan-period">par mois</div>
      <ul class="plan-features">
        <li><span class="check">‚úì</span> Scans illimit√©s</li>
        <li><span class="check">‚úì</span> Scan auto sur d√©placement</li>
        <li><span class="check">‚úì</span> Analyse de cha√Ænage avanc√©e</li>
        <li><span class="check">‚úì</span> Export PDF & Excel</li>
        <li><span class="check">‚úì</span> Historique 6 mois</li>
      </ul>
      <button class="btn btn-green btn-block" onclick="selectPlan('pro')">Choisir Pro</button>
    </div>

    <!-- ENTERPRISE -->
    <div class="price-card">
      <div class="plan-name">Entreprise</div>
      <div class="plan-price">499<sup>MAD</sup></div>
      <div class="plan-period">par mois</div>
      <ul class="plan-features">
        <li><span class="check">‚úì</span> Tout du plan Pro</li>
        <li><span class="check">‚úì</span> API acc√®s direct</li>
        <li><span class="check">‚úì</span> Multi-utilisateurs (10)</li>
        <li><span class="check">‚úì</span> Support prioritaire</li>
        <li><span class="check">‚úì</span> Historique illimit√©</li>
      </ul>
      <button class="btn btn-outline btn-block" onclick="selectPlan('enterprise')">Contacter</button>
    </div>
  </div>

  <div class="pricing-back">
    <button class="btn btn-ghost" onclick="showPage('pageApp')">‚Üê Retour √† l'application</button>
  </div>
</div>

<!-- ==================== PAGE: STRIPE CHECKOUT (simulated) ==================== -->
<div class="page auth-page" id="pageCheckout">
  <div class="auth-backdrop">
    <div class="orb"></div><div class="orb"></div><div class="orb"></div>
  </div>
  <div class="auth-card" style="max-width:460px;">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:24px;">
      <div style="font-size:28px;">üí≥</div>
      <div>
        <div style="font-size:18px;font-weight:700;">Paiement s√©curis√©</div>
        <div style="font-size:12px;color:var(--text-muted);">Powered by Stripe</div>
      </div>
      <div style="margin-left:auto;">
        <svg width="60" height="25" viewBox="0 0 60 25"><rect width="60" height="25" rx="4" fill="#635BFF"/><text x="30" y="17" text-anchor="middle" fill="white" font-size="12" font-weight="700" font-family="sans-serif">stripe</text></svg>
      </div>
    </div>

    <div style="background:var(--bg-input);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:20px;">
      <div style="display:flex;justify-content:space-between;font-size:14px;">
        <span>Plan <strong id="checkoutPlanName">Pro</strong></span>
        <span style="font-family:var(--font-mono);font-weight:700;" id="checkoutPlanPrice">199 MAD/mois</span>
      </div>
    </div>

    <div class="form-group">
      <label>Num√©ro de carte</label>
      <input class="form-input" type="text" id="cardNumber" placeholder="4242 4242 4242 4242" maxlength="19" oninput="formatCardNumber(this)" />
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="form-group">
        <label>Expiration</label>
        <input class="form-input" type="text" id="cardExpiry" placeholder="MM/AA" maxlength="5" oninput="formatExpiry(this)" />
      </div>
      <div class="form-group">
        <label>CVC</label>
        <input class="form-input" type="text" id="cardCVC" placeholder="123" maxlength="3" />
      </div>
    </div>

    <div class="form-group">
      <label>Nom sur la carte</label>
      <input class="form-input" type="text" id="cardName" placeholder="MOHAMMED ALAMI" />
    </div>

    <div class="form-error" id="checkoutError"></div>

    <button class="btn btn-green btn-block" id="payBtn" onclick="handlePayment()">
      üîí Payer maintenant
    </button>

    <div style="text-align:center;margin-top:14px;">
      <button class="btn btn-ghost" onclick="showPage('pagePricing')">‚Üê Retour aux plans</button>
    </div>
  </div>
</div>

<!-- ==================== PAGE: PAYMENT SUCCESS ==================== -->
<div class="page auth-page" id="pageSuccess">
  <div class="auth-backdrop">
    <div class="orb"></div><div class="orb"></div><div class="orb"></div>
  </div>
  <div class="auth-card success-card">
    <div class="success-icon">‚úì</div>
    <div class="auth-title">Paiement r√©ussi !</div>
    <div class="auth-subtitle" style="margin-bottom:12px;">
      Votre abonnement <strong id="successPlan">Pro</strong> est maintenant actif.
    </div>
    <div style="background:var(--green-dim);border:1px solid rgba(16,185,129,0.2);border-radius:10px;padding:14px;margin-bottom:24px;">
      <div style="font-family:var(--font-mono);font-size:12px;color:var(--green);text-align:center;">
        R√©f: TXN-<span id="txnRef">2026021500001</span>
      </div>
    </div>
    <button class="btn btn-green btn-block" onclick="showPage('pageApp')">
      Acc√©der √† l'application ‚Üí
    </button>
  </div>
</div>

<!-- ==================== PAGE: MAIN APP ==================== -->
<div class="page app-page" id="pageApp">
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-header-left">
        <div class="s-logo">‚öïÔ∏è</div>
        <div class="s-logo-text">
          <h1>Cha√Ænage</h1>
          <span>Pro</span>
        </div>
      </div>
      <div class="header-actions">
        <button class="header-btn" onclick="toggleTheme()" title="Th√®me" id="sidebarThemeBtn">üåô</button>
        <button class="header-btn" onclick="showPage('pagePricing')" title="Plans">üíé</button>
      </div>
    </div>

    <div class="user-pill" id="userPill">
      <div class="user-avatar" id="userAvatar">M</div>
      <div class="user-info">
        <div class="user-name" id="userName">Mohammed</div>
        <div class="user-plan" id="userPlanBadge">PRO</div>
      </div>
      <button class="user-logout" onclick="handleLogout()">D√©connexion</button>
    </div>

    <div class="scan-indicator" id="scanIndicator">
      <div class="scan-dot"></div>
      <div class="scan-text">D√©placez la carte pour scanner</div>
      <div class="scan-count" id="scanCount" style="display:none;">0</div>
    </div>

    <div class="auto-scan-row">
      <label class="toggle-switch">
        <input type="checkbox" id="autoScanToggle" checked onchange="autoScanEnabled=this.checked">
        <div class="toggle-track"></div>
        <div class="toggle-thumb"></div>
      </label>
      <span style="flex:1;">Scan auto</span>
      <button class="btn-scan-sm" onclick="scanCurrentView()">‚ü≥ Scanner</button>
    </div>

    <div class="stats-bar">
      <div class="stat-chip green">
        <div class="stat-value" id="statValid">0</div>
        <div class="stat-label">Conformes</div>
      </div>
      <div class="stat-chip red">
        <div class="stat-value" id="statConflict">0</div>
        <div class="stat-label">Conflits</div>
      </div>
      <div class="stat-chip amber">
        <div class="stat-value" id="statTotal">0</div>
        <div class="stat-label">Total</div>
      </div>
    </div>

    <div class="list-header">
      <h3>Pharmacies</h3>
      <div class="filter-pills">
        <button class="filter-pill active" onclick="setFilter('all',this)">Tous</button>
        <button class="filter-pill" onclick="setFilter('conflict',this)">Conflits</button>
        <button class="filter-pill" onclick="setFilter('valid',this)">OK</button>
      </div>
    </div>

    <div class="pharmacy-list" id="pharmacyList">
      <div style="text-align:center;padding:40px 20px;color:var(--text-muted);">
        <div style="font-size:36px;margin-bottom:10px;">üó∫Ô∏è</div>
        <p style="font-size:13px;line-height:1.6;">Naviguez sur la carte.<br>Les pharmacies s'affichent <strong style="color:var(--green);">automatiquement</strong>.</p>
      </div>
    </div>

    <div class="config-panel">
      <div class="config-row">
        <label>Distance min</label>
        <input type="range" id="distanceRange" min="100" max="500" value="300" step="10" oninput="updateDistance(this.value)" />
        <div class="range-val" id="distanceValue">300m</div>
      </div>
      <div class="config-row">
        <label>P√©rim√®tres</label>
        <label class="toggle-switch">
          <input type="checkbox" id="showCircles" checked onchange="toggleCircles()">
          <div class="toggle-track"></div>
          <div class="toggle-thumb"></div>
        </label>
      </div>
    </div>
  </div>

  <div class="map-container">
    <div id="map"></div>
    <div class="map-scan-bar" id="mapScanBar"></div>

    <div class="map-overlay">
      <h4>L√©gende</h4>
      <div class="legend-item">
        <div class="legend-dot green"></div>
        Conforme (‚â• <span id="legendDist">300</span>m)
      </div>
      <div class="legend-item">
        <div class="legend-dot red"></div>
        Conflit (&lt; <span id="legendDist2">300</span>m)
      </div>
      <div class="legend-item">
        <div class="legend-dot amber"></div>
        P√©rim√®tre
      </div>
    </div>

    <div class="move-hint" id="moveHint">
      <span class="hi">üëÜ</span>
      D√©placez et zoomez ‚Äî scan automatique
    </div>
  </div>
</div>

<!-- ============================================================
     JAVASCRIPT
     ============================================================ -->
<script>
// ===================== THEME =====================
function getTheme() {
  return document.documentElement.getAttribute('data-theme');
}

function toggleTheme() {
  const next = getTheme() === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  const icon = next === 'dark' ? 'üåô' : '‚òÄÔ∏è';
  document.getElementById('themeToggle').textContent = icon;
  document.getElementById('sidebarThemeBtn').textContent = icon;
  try { localStorage.setItem('chainage-theme', next); } catch(e) {}
  // Update map style if map exists
  if (map && map.setOptions) {
    map.setOptions({ styles: next === 'dark' ? darkMapStyle : lightMapStyle });
  }
}

// Restore saved theme
try {
  const saved = localStorage.getItem('chainage-theme');
  if (saved) {
    document.documentElement.setAttribute('data-theme', saved);
    const icon = saved === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    document.getElementById('themeToggle').textContent = icon;
  }
} catch(e) {}

// ===================== PAGE NAVIGATION =====================
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  // Re-trigger map resize if showing app
  if (id === 'pageApp' && map) {
    setTimeout(() => google.maps.event.trigger(map, 'resize'), 100);
  }
}

// ===================== AUTH STATE =====================
let currentUser = null;

function setUser(user) {
  currentUser = user;
  try { localStorage.setItem('chainage-user', JSON.stringify(user)); } catch(e) {}
  updateUserUI();
}

function loadUser() {
  try {
    const saved = localStorage.getItem('chainage-user');
    if (saved) {
      currentUser = JSON.parse(saved);
      updateUserUI();
      return true;
    }
  } catch(e) {}
  return false;
}

function updateUserUI() {
  if (!currentUser) return;
  const initials = currentUser.name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0,2);
  document.getElementById('userAvatar').textContent = initials;
  document.getElementById('userName').textContent = currentUser.name;
  document.getElementById('userPlanBadge').textContent = (currentUser.plan || 'free').toUpperCase();
}

// ===================== LOGIN =====================
function handleLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPassword').value;
  const errEl = document.getElementById('loginError');

  if (!email || !pass) {
    errEl.textContent = 'Veuillez remplir tous les champs';
    errEl.classList.add('visible');
    return;
  }

  if (!email.includes('@')) {
    errEl.textContent = 'Adresse email invalide';
    errEl.classList.add('visible');
    return;
  }

  errEl.classList.remove('visible');

  // Check stored users
  const users = getStoredUsers();
  const user = users.find(u => u.email === email);
  if (user && user.password === pass) {
    setUser(user);
    showPage('pageApp');
    initMapIfNeeded();
    return;
  }

  if (user) {
    errEl.textContent = 'Mot de passe incorrect';
    errEl.classList.add('visible');
    return;
  }

  // Auto-create account on first login
  const newUser = { name: email.split('@')[0], email, password: pass, plan: 'free', city: '' };
  saveUser(newUser);
  setUser(newUser);
  showPage('pagePricing');
}

function handleDemoLogin() {
  setUser({ name: 'Utilisateur Demo', email: 'demo@chainage.ma', plan: 'pro', city: 'Casablanca' });
  showPage('pageApp');
  initMapIfNeeded();
}

// ===================== REGISTER =====================
function handleRegister() {
  const name = document.getElementById('regName').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const pass = document.getElementById('regPassword').value;
  const city = document.getElementById('regCity').value.trim();
  const errEl = document.getElementById('regError');

  if (!name || !email || !pass) {
    errEl.textContent = 'Veuillez remplir tous les champs obligatoires';
    errEl.classList.add('visible');
    return;
  }

  if (pass.length < 8) {
    errEl.textContent = 'Le mot de passe doit contenir au moins 8 caract√®res';
    errEl.classList.add('visible');
    return;
  }

  if (!email.includes('@')) {
    errEl.textContent = 'Adresse email invalide';
    errEl.classList.add('visible');
    return;
  }

  const users = getStoredUsers();
  if (users.find(u => u.email === email)) {
    errEl.textContent = 'Un compte avec cet email existe d√©j√†';
    errEl.classList.add('visible');
    return;
  }

  errEl.classList.remove('visible');

  const user = { name, email, password: pass, plan: 'free', city };
  saveUser(user);
  setUser(user);
  showPage('pagePricing');
}

// ===================== USER STORAGE =====================
function getStoredUsers() {
  try {
    return JSON.parse(localStorage.getItem('chainage-users') || '[]');
  } catch(e) { return []; }
}

function saveUser(user) {
  const users = getStoredUsers();
  const idx = users.findIndex(u => u.email === user.email);
  if (idx >= 0) users[idx] = user;
  else users.push(user);
  try { localStorage.setItem('chainage-users', JSON.stringify(users)); } catch(e) {}
}

function handleLogout() {
  currentUser = null;
  try { localStorage.removeItem('chainage-user'); } catch(e) {}
  showPage('pageLogin');
}

// ===================== PRICING & STRIPE =====================
let selectedPlan = 'pro';

function selectPlan(plan) {
  if (plan === 'free') {
    if (currentUser) {
      currentUser.plan = 'free';
      setUser(currentUser);
      saveUser(currentUser);
    }
    showPage('pageApp');
    initMapIfNeeded();
    return;
  }

  if (plan === 'enterprise') {
    alert('Contactez-nous √† enterprise@chainage.ma pour un devis personnalis√©.');
    return;
  }

  selectedPlan = plan;
  const prices = { pro: '199 MAD/mois', enterprise: '499 MAD/mois' };
  document.getElementById('checkoutPlanName').textContent = plan.charAt(0).toUpperCase() + plan.slice(1);
  document.getElementById('checkoutPlanPrice').textContent = prices[plan] || '';
  showPage('pageCheckout');
}

function formatCardNumber(input) {
  let v = input.value.replace(/\D/g, '').slice(0, 16);
  input.value = v.replace(/(\d{4})(?=\d)/g, '$1 ');
}

function formatExpiry(input) {
  let v = input.value.replace(/\D/g, '').slice(0, 4);
  if (v.length >= 2) v = v.slice(0,2) + '/' + v.slice(2);
  input.value = v;
}

function handlePayment() {
  const num = document.getElementById('cardNumber').value.replace(/\s/g, '');
  const exp = document.getElementById('cardExpiry').value;
  const cvc = document.getElementById('cardCVC').value;
  const name = document.getElementById('cardName').value;
  const errEl = document.getElementById('checkoutError');

  if (num.length < 16 || !exp || cvc.length < 3 || !name) {
    errEl.textContent = 'Veuillez remplir toutes les informations de paiement';
    errEl.classList.add('visible');
    return;
  }

  errEl.classList.remove('visible');

  // Simulate Stripe processing
  const payBtn = document.getElementById('payBtn');
  payBtn.disabled = true;
  payBtn.innerHTML = '<span style="display:inline-block;width:18px;height:18px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 0.6s linear infinite;"></span> Traitement...';

  setTimeout(() => {
    // Success!
    if (currentUser) {
      currentUser.plan = selectedPlan;
      setUser(currentUser);
      saveUser(currentUser);
    }

    document.getElementById('successPlan').textContent = selectedPlan.charAt(0).toUpperCase() + selectedPlan.slice(1);
    document.getElementById('txnRef').textContent = 'TXN-' + Date.now().toString().slice(-10);

    payBtn.disabled = false;
    payBtn.innerHTML = 'üîí Payer maintenant';

    // Clear form
    document.getElementById('cardNumber').value = '';
    document.getElementById('cardExpiry').value = '';
    document.getElementById('cardCVC').value = '';
    document.getElementById('cardName').value = '';

    showPage('pageSuccess');
  }, 2200);
}

// ===================== MAP APP STATE =====================
let MIN_DISTANCE = 300;
let map, placesService;
let pharmacyMarkers = [];
let pharmacyCircles = [];
let pharmacies = [];
let infoWindow;
let autoScanEnabled = false;
let currentFilter = 'all';
let scanDebounceTimer = null;
let isScanning = false;
let hintVisible = true;
let mapInitialized = false;

const darkMapStyle = [
  { elementType:"geometry", stylers:[{color:"#0f172a"}] },
  { elementType:"labels.text.stroke", stylers:[{color:"#0f172a"}] },
  { elementType:"labels.text.fill", stylers:[{color:"#64748b"}] },
  { featureType:"administrative", elementType:"geometry.stroke", stylers:[{color:"#1e293b"}] },
  { featureType:"road", elementType:"geometry", stylers:[{color:"#1e293b"}] },
  { featureType:"road", elementType:"geometry.stroke", stylers:[{color:"#0f172a"}] },
  { featureType:"road.highway", elementType:"geometry", stylers:[{color:"#334155"}] },
  { featureType:"water", elementType:"geometry", stylers:[{color:"#0c1426"}] },
  { featureType:"poi.park", elementType:"geometry", stylers:[{color:"#0d2818"}] },
  { featureType:"poi", elementType:"labels", stylers:[{visibility:"off"}] },
  { featureType:"transit", stylers:[{visibility:"off"}] },
];

const lightMapStyle = [
  { elementType:"geometry", stylers:[{color:"#f5f5f5"}] },
  { elementType:"labels.text.fill", stylers:[{color:"#616161"}] },
  { elementType:"labels.text.stroke", stylers:[{color:"#f5f5f5"}] },
  { featureType:"administrative", elementType:"geometry.stroke", stylers:[{color:"#c9c9c9"}] },
  { featureType:"road", elementType:"geometry", stylers:[{color:"#ffffff"}] },
  { featureType:"road.highway", elementType:"geometry", stylers:[{color:"#dadada"}] },
  { featureType:"water", elementType:"geometry", stylers:[{color:"#c9d7e8"}] },
  { featureType:"poi.park", elementType:"geometry", stylers:[{color:"#c5e8c5"}] },
  { featureType:"poi", elementType:"labels", stylers:[{visibility:"off"}] },
  { featureType:"transit", stylers:[{visibility:"off"}] },
];

// ===================== MAP FUNCTIONS =====================
function haversineDistance(lat1,lon1,lat2,lon2) {
  const R = 6371000;
  const dLat = (lat2-lat1)*Math.PI/180;
  const dLon = (lon2-lon1)*Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function analyzeChainage() {
  pharmacies.forEach((p,i) => {
    p.conflicts = [];
    p.minDistance = Infinity;
    pharmacies.forEach((q,j) => {
      if (i===j) return;
      const d = haversineDistance(p.lat,p.lng,q.lat,q.lng);
      if (d < MIN_DISTANCE) p.conflicts.push({name:q.name,distance:Math.round(d)});
      if (d < p.minDistance) p.minDistance = Math.round(d);
    });
    p.status = p.conflicts.length > 0 ? 'conflict' : 'valid';
  });
  document.getElementById('statValid').textContent = pharmacies.filter(p=>p.status==='valid').length;
  document.getElementById('statConflict').textContent = pharmacies.filter(p=>p.status==='conflict').length;
  document.getElementById('statTotal').textContent = pharmacies.length;
}

function clearMap() {
  pharmacyMarkers.forEach(m=>m.setMap(null));
  pharmacyCircles.forEach(c=>c.setMap(null));
  pharmacyMarkers = [];
  pharmacyCircles = [];
  if (infoWindow) infoWindow.close();
}

function renderPharmacies() {
  clearMap();
  analyzeChainage();
  const showCirc = document.getElementById('showCircles').checked;
  const isDark = getTheme() === 'dark';

  pharmacies.forEach((p,idx) => {
    const bad = p.status === 'conflict';
    const color = bad ? '#ef4444' : '#10b981';

    const marker = new google.maps.Marker({
      position:{lat:p.lat,lng:p.lng}, map,
      icon:{
        path: google.maps.SymbolPath.CIRCLE,
        fillColor: color, fillOpacity:1,
        strokeColor: isDark ? '#fff' : '#111', strokeWeight:2, scale:9
      },
      title: p.name,
      zIndex: bad ? 10 : 5
    });

    marker.addListener('click', () => {
      const ch = p.conflicts.length > 0
        ? p.conflicts.map(c=>`<div style="color:#ef4444;font-size:12px;margin-top:3px;">‚ö† ${c.name}: <b>${c.distance}m</b></div>`).join('')
        : '<div style="color:#10b981;font-size:12px;">‚úì Aucun conflit</div>';

      infoWindow.setContent(`
        <div style="font-family:'DM Sans',sans-serif;padding:6px;min-width:220px;background:var(--infowindow-bg);color:var(--infowindow-text);">
          <div style="font-weight:700;font-size:14px;margin-bottom:3px;">${p.name}</div>
          <div style="color:var(--infowindow-muted);font-size:11px;margin-bottom:8px;">${p.address}</div>
          <div style="border-top:1px solid var(--border);padding-top:8px;">
            <div style="font-size:10px;color:var(--infowindow-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Cha√Ænage (${MIN_DISTANCE}m)</div>
            <div style="font-size:13px;margin-bottom:4px;">Dist. min: <b>${p.minDistance===Infinity?'‚Äî':p.minDistance+'m'}</b></div>
            ${ch}
          </div>
        </div>
      `);
      infoWindow.open(map, marker);
    });

    pharmacyMarkers.push(marker);

    if (showCirc) {
      pharmacyCircles.push(new google.maps.Circle({
        center:{lat:p.lat,lng:p.lng}, radius:MIN_DISTANCE,
        fillColor:color, fillOpacity:0.06,
        strokeColor:color, strokeOpacity:0.3, strokeWeight:1.5,
        map, clickable:false
      }));
    }
  });

  renderList();
  updateScanUI(false);
}

function renderList() {
  const c = document.getElementById('pharmacyList');
  if (!pharmacies.length) {
    c.innerHTML = `<div style="text-align:center;padding:40px 20px;color:var(--text-muted);"><div style="font-size:36px;margin-bottom:10px;">üó∫Ô∏è</div><p style="font-size:13px;line-height:1.6;">Naviguez sur la carte.<br>Les pharmacies s'affichent <strong style="color:var(--green);">automatiquement</strong>.</p></div>`;
    return;
  }

  let list = [...pharmacies];
  if (currentFilter==='conflict') list = list.filter(p=>p.status==='conflict');
  else if (currentFilter==='valid') list = list.filter(p=>p.status==='valid');
  list.sort((a,b) => {
    if (a.status==='conflict'&&b.status!=='conflict') return -1;
    if (a.status!=='conflict'&&b.status==='conflict') return 1;
    return (a.minDistance||Infinity) - (b.minDistance||Infinity);
  });

  if (!list.length) { c.innerHTML = `<div style="text-align:center;padding:30px;color:var(--text-muted);font-size:13px;">Aucune avec ce filtre.</div>`; return; }

  c.innerHTML = list.map(p => {
    const idx = pharmacies.indexOf(p);
    return `<div class="pharmacy-card ${p.status}" onclick="focusPharmacy(${idx})">
      <div class="card-top"><div class="p-name">${p.name}</div><div class="p-badge ${p.status}">${p.status==='conflict'?'Conflit':'OK'}</div></div>
      <div class="p-address">${p.address}</div>
      <div class="p-meta"><span>Min:</span> ${p.minDistance===Infinity?'‚Äî':p.minDistance+'m'}${p.conflicts.length?` <span style="color:var(--red);">‚ö† ${p.conflicts.length}</span>`:''}</div>
    </div>`;
  }).join('');
}

function setFilter(f, el) {
  currentFilter = f;
  document.querySelectorAll('.filter-pill').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  renderList();
}

function focusPharmacy(idx) {
  const p = pharmacies[idx];
  const was = autoScanEnabled;
  autoScanEnabled = false;
  map.panTo({lat:p.lat,lng:p.lng});
  map.setZoom(17);
  setTimeout(() => { google.maps.event.trigger(pharmacyMarkers[idx],'click'); autoScanEnabled = was; }, 400);
}

// ===================== SCAN =====================
function scanCurrentView() {
  if (!placesService || isScanning) return;
  isScanning = true;
  updateScanUI(true);
  hideHint();

  const center = map.getCenter();
  const bounds = map.getBounds();
  let radius = 2000;
  if (bounds) {
    const ne = bounds.getNorthEast();
    radius = haversineDistance(center.lat(),center.lng(),ne.lat(),ne.lng());
    radius = Math.max(500, Math.min(radius, 50000));
  }

  let all = [];
  placesService.nearbySearch({location:center, radius, type:'pharmacy'}, function cb(res, status, pag) {
    if (status === google.maps.places.PlacesServiceStatus.OK && res) {
      all = all.concat(res);
      if (pag && pag.hasNextPage && all.length < 60) setTimeout(() => pag.nextPage(), 300);
      else finish(all);
    } else if (all.length) finish(all);
    else { isScanning=false; pharmacies=[]; renderPharmacies(); }
  });
}

function finish(results) {
  const seen = new Set();
  pharmacies = results.filter(r => {
    if (seen.has(r.place_id)) return false;
    seen.add(r.place_id); return true;
  }).map(r => ({
    name:r.name,
    lat:r.geometry.location.lat(),
    lng:r.geometry.location.lng(),
    address:r.vicinity||r.formatted_address||'',
    placeId:r.place_id
  }));
  isScanning = false;
  renderPharmacies();
}

function updateScanUI(scanning) {
  const ind = document.getElementById('scanIndicator');
  const cnt = document.getElementById('scanCount');
  const bar = document.getElementById('mapScanBar');
  if (scanning) {
    ind.classList.add('scanning');
    ind.querySelector('.scan-text').textContent = 'Scan en cours...';
    bar.classList.add('active');
  } else {
    ind.classList.remove('scanning');
    bar.classList.remove('active');
    if (pharmacies.length) {
      ind.querySelector('.scan-text').textContent = `${pharmacies.length} pharmacies dans la zone`;
      cnt.textContent = pharmacies.length;
      cnt.style.display = 'inline';
    } else {
      ind.querySelector('.scan-text').textContent = 'D√©placez la carte pour scanner';
      cnt.style.display = 'none';
    }
  }
}

function hideHint() {
  if (!hintVisible) return;
  const h = document.getElementById('moveHint');
  h.style.opacity = '0';
  setTimeout(() => h.style.display = 'none', 500);
  hintVisible = false;
}

function onMapIdle() {
  if (!autoScanEnabled || !placesService) return;
  clearTimeout(scanDebounceTimer);
  scanDebounceTimer = setTimeout(scanCurrentView, 700);
}

// ===================== CONTROLS =====================
function updateDistance(v) {
  MIN_DISTANCE = parseInt(v);
  document.getElementById('distanceValue').textContent = v+'m';
  document.getElementById('legendDist').textContent = v;
  document.getElementById('legendDist2').textContent = v;
  if (pharmacies.length) renderPharmacies();
}

function toggleCircles() { if (pharmacies.length) renderPharmacies(); }

// ===================== INIT MAP =====================
function initMapIfNeeded() {
  if (mapInitialized) return;
  loadGoogleMaps();
}

function initMap() {
  mapInitialized = true;
  const style = getTheme() === 'dark' ? darkMapStyle : lightMapStyle;

  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat:33.5731, lng:-7.5898},
    zoom: 15,
    styles: style,
    disableDefaultUI: true,
    zoomControl: true,
    fullscreenControl: true,
  });

  infoWindow = new google.maps.InfoWindow();

  try { placesService = new google.maps.places.PlacesService(map); }
  catch(e) { console.warn('Places API unavailable'); }

  map.addListener('idle', onMapIdle);

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => { map.setCenter({lat:pos.coords.latitude,lng:pos.coords.longitude}); map.setZoom(15); },
      () => {},
      {timeout:5000}
    );
  }
}

function loadGoogleMaps() {
  const params = new URLSearchParams(window.location.search);
  const key = params.get('key') || '';
  const s = document.createElement('script');
  s.src = key
    ? `https://maps.googleapis.com/maps/api/js?key=${key}&callback=initMap&libraries=places&v=weekly`
    : `https://maps.googleapis.com/maps/api/js?callback=initMap&libraries=places&v=weekly`;
  s.async = true;
  s.defer = true;
  s.onerror = () => {
    document.getElementById('map').innerHTML = `
      <div style="width:100%;height:100%;background:var(--map-bg);display:flex;align-items:center;justify-content:center;">
        <div style="text-align:center;color:var(--text-muted);max-width:420px;padding:40px;">
          <div style="font-size:56px;margin-bottom:16px;">üîë</div>
          <div style="font-size:18px;font-weight:700;color:var(--text-primary);margin-bottom:10px;">Cl√© API requise</div>
          <div style="font-size:14px;line-height:1.6;margin-bottom:20px;">Ajoutez votre cl√© Google Maps dans l'URL :</div>
          <code style="display:block;background:var(--bg-card);padding:14px;border-radius:10px;font-family:var(--font-mono);font-size:12px;color:var(--green);word-break:break-all;">?key=VOTRE_CLE_API</code>
          <div style="font-size:12px;color:var(--text-muted);margin-top:14px;">APIs: Maps JavaScript + Places</div>
        </div>
      </div>`;
  };
  document.head.appendChild(s);
}

// ===================== BOOT =====================
(function boot() {
  // Check if user is already logged in
  if (loadUser()) {
    showPage('pageApp');
    initMapIfNeeded();
  }
})();
</script>
</body>
</html>
